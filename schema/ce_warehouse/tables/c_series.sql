/*
 ***********************************************************************************************************
 * @file
 * c_series.sql
 *
 * Control table - series definition, lookup/validation.
 ***********************************************************************************************************
 */

-- DROP TABLE IF EXISTS ce_warehouse.c_series;

CREATE TABLE IF NOT EXISTS ce_warehouse.c_series
(
    pk_s INT GENERATED BY DEFAULT AS IDENTITY,
    
    gcode TEXT NOT NULL
        CHECK (gcode ~ '^[GC]\.[A-Z0-9_]+[A-Z0-9]$' OR gcode = 'INTERNAL'),
    icode TEXT NOT NULL
        REFERENCES ce_warehouse.c_ind (code)
            DEFERRABLE INITIALLY DEFERRED
            ON UPDATE CASCADE
            ON DELETE RESTRICT,
    series_id TEXT GENERATED ALWAYS
        AS (gcode || '_' || icode) STORED,  -- Series code
    name TEXT NOT NULL,
    name1 TEXT,
    name2 TEXT,
    name3 TEXT,
    name4 TEXT,
    description TEXT,
    source_annotation TEXT,
    units TEXT,
    precision INT NOT NULL
        CHECK (precision BETWEEN -1 AND 12),  -- number of decimal places for rounding in PowerBI
    date_point TEXT NOT NULL DEFAULT 'mid'
        CHECK (date_point IN ('start', 'mid', 'end')),  -- where to place the date point for the period in PowerBI
    active BOOL NOT NULL DEFAULT TRUE,
    ordering INT NOT NULL DEFAULT 0,

    internal_notes TEXT,  -- Unvalidated!

    error TEXT,
    updated_utc TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    PRIMARY KEY (pk_s),
    UNIQUE (gcode, icode),
    UNIQUE (series_id)
);

COMMENT ON TABLE ce_warehouse.c_series
    IS 'Control table - series definition, lookup/validation';
